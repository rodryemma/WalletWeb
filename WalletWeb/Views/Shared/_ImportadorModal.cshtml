<button class="btn btn-sm btn-outline-success" id="abrirImportBtn">
    <i class="bi bi-file-earmark-excel"></i> Importar Excel
</button>

<!-- Modal de seleccionar archivo -->
<div class="modal fade" id="abrirImportModal" tabindex="-1" data-bs-backdrop="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="container py-3">
                <div class="row justify-content-center">
                    <div class="col-12">
                        <div class="card main-card">

                            <div class="card-header bg-transparent border-0 py-5">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-file-earmark-spreadsheet fs-1 text-primary me-3"></i>
                                    <div class="modal-title" >
                                        <h2 class="mb-1 fw-bold">Importar Transacciones</h2>
                                        <p class="text-muted mb-0">Sube tu archivo Excel y gestiona tu inventario</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card-body p-3">
                                <!-- Zona de carga -->
                                <div class="upload-zone p-5 text-center mb-4" id="uploadZone">
                                    <input type="file" id="excelFileInput" class="d-none" accept=".xlsx,.xls">
                                    <i class="bi bi-cloud-arrow-up fs-1 text-muted mb-3 d-block"></i>
                                    <h5 class="mb-2">Arrastra tu archivo Excel aquí</h5>
                                    <p class="text-muted mb-3">o haz clic para seleccionar</p>
                                    <button class="btn btn-primary btn-lg" id="selectFileBtn">
                                        <i class="bi bi-plus-circle me-2"></i>Seleccionar archivo
                                    </button>
                                    <small class="d-block text-muted mt-3">
                                        Formatos soportados: .xlsx, .xls | Máximo: 10MB
                                    </small>
                                </div>

                                <!-- Información del archivo seleccionado -->
                                <div id="fileInfoAlert" class="alert alert-info file-info d-none">

                                    <p class="mb-0">¿Estás seguro que deseas importar este archivo Excel?</p>
                                    <small class="text-muted">Los datos se procesarán y se agregarán a tu inventario.</small>

                                    <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-check fs-4 me-3"></i>
                                            <div>
                                                <h6 class="mb-1" id="fileName">2025_10_03_10_20_15_258889.xlsx</h6>
                                                <small id="fileDetails" class="text-muted">13.22 kB • Excel</small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 flex-shrink-0">
                                            <button class="btn btn-primary" id="modalConfirmBtn">
                                                <i class="bi bi-upload me-2"></i>Sí, importar
                                            </button>
                                            <button class="btn btn-outline-secondary" id="cancelBtn">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal de confirmación 
<div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle text-primary me-2"></i>
                    Confirmar importación
                </h5>
            </div>
            <div class="modal-body">
                <div class="file-info p-3 mb-3">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Archivo</small>
                            <span id="modalFileName" class="fw-semibold">-</span>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Tamaño</small>
                            <span id="modalFileSize" class="fw-semibold">-</span>
                        </div>
                    </div>
                </div>
                <p class="mb-0">¿Estás seguro que deseas importar este archivo Excel?</p>
                <small class="text-muted">Los datos se procesarán y se agregarán a tu inventario.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modalCancelBtn">
                    <i class="bi bi-x-lg me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="modalConfirmBtnEliminar">
                    <i class="bi bi-check-lg me-2"></i>Sí, importar
                </button>
            </div>
        </div>
    </div>
</div>
-->


<!-- Modal de progreso -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h5 class="mb-2">Procesando archivo Excel</h5>
                <p class="text-muted mb-3">Por favor espera mientras importamos tus datos...</p>
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="progressBar" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="progressText">Iniciando...</small>
            </div>
        </div>
    </div>
</div>

<!-- Modal de resultados -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Importación completada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Estadísticas -->
                <div class="row g-3 mb-4" id="statsContainer">
                    <div class="col-6 col-md-3">
                        <div class="card stat-card text-center p-3">
                            <h3 class="mb-1" id="totalRows">0</h3>
                            <small>Total filas</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card stat-card text-center p-3">
                            <h3 class="mb-1" id="processedRows">0</h3>
                            <small>Importados</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card stat-card text-center p-3">
                            <h3 class="mb-1" id="errorRows">0</h3>
                            <small>Con errores</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card stat-card text-center p-3">
                            <h3 class="mb-1" id="successRate">0%</h3>
                            <small>Éxito</small>
                        </div>
                    </div>
                </div>

                <!-- Mensaje de resultado -->
                <div class="alert alert-success mb-3" id="resultMessage">
                    Importación completada exitosamente
                </div>

                <!-- Lista de errores -->
                <div id="errorSection" class="d-none">
                    <h6 class="text-danger mb-2">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Errores encontrados
                    </h6>
                    <div class="alert alert-light error-list" id="errorList">
                        <!-- Los errores se cargan aquí -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Ver transacciones
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de error -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-x-circle me-2"></i>
                    Error en la importación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">Ha ocurrido un error inesperado</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
    // Variables globales
    let selectedFile = null;
    const API_BASE_URL = '/excel';

    // Referencias a modals
    const abrirImportModal = new bootstrap.Modal(document.getElementById('abrirImportModal'));
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));

    // Referencias a elementos
    const elements = {
        abrirImport : document.getElementById('abrirImportBtn'),
        fileInput: document.getElementById('excelFileInput'),
        selectBtn: document.getElementById('selectFileBtn'),
        uploadZone: document.getElementById('uploadZone'),
        fileInfoAlert: document.getElementById('fileInfoAlert'),
        fileName: document.getElementById('fileName'),
        fileDetails: document.getElementById('fileDetails'),
        cancelBtn: document.getElementById('cancelBtn'),
        modalFileName: document.getElementById('modalFileName'),
        modalFileSize: document.getElementById('modalFileSize'),
        modalConfirmBtn: document.getElementById('modalConfirmBtn'),
        modalCancelBtn: document.getElementById('modalCancelBtn'),
        progressBar: document.getElementById('progressBar'),
        progressText: document.getElementById('progressText')
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', initializeEventListeners);

    function initializeEventListeners() {
        // Eventos de selección de archivo
        elements.selectBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileSelection);

        // Eventos de botones
        elements.abrirImport.addEventListener('click', showAbrirImportModal);
        elements.cancelBtn.addEventListener('click', resetForm);
        elements.modalConfirmBtn.addEventListener('click', handleImportConfirmation);

        // Drag & Drop
        elements.uploadZone.addEventListener('dragover', handleDragOver);
        elements.uploadZone.addEventListener('dragleave', handleDragLeave);
        elements.uploadZone.addEventListener('drop', handleDrop);
    }

    // Drag & Drop handlers
    function handleDragOver(e) {
        e.preventDefault();
        elements.uploadZone.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        elements.uploadZone.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        elements.uploadZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (isValidExcelFile(file)) {
                elements.fileInput.files = files;
                handleFileSelection({ target: { files: files } });
            } else {
                showErrorModal('Por favor arrastra un archivo Excel válido (.xlsx o .xls)');
            }
        }
    }

    // Manejar selección de archivo
    function handleFileSelection(event) {
        const file = event.target.files[0];

        if (!file) {
            resetForm();
            return;
        }

        if (!isValidExcelFile(file)) {
            showErrorModal('Por favor selecciona un archivo Excel válido (.xlsx o .xls)');
            resetForm();
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            showErrorModal('El archivo es demasiado grande. Tamaño máximo: 10MB');
            resetForm();
            return;
        }

        selectedFile = file;
        showFileInfo(file);
    }

    // Validar archivo Excel
    function isValidExcelFile(file) {
        const validTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-excel'
        ];
        const validExtensions = ['.xlsx', '.xls'];
        const fileName = file.name.toLowerCase();

        return validTypes.includes(file.type) ||
               validExtensions.some(ext => fileName.endsWith(ext));
    }

    // Mostrar modal de seleccionar archivo
    function showAbrirImportModal() {
        abrirImportModal.show();
    }

    // Mostrar información del archivo
    function showFileInfo(file) {
        elements.fileName.textContent = file.name;
        elements.fileDetails.textContent = `${formatFileSize(file.size)} • Excel`;
        elements.fileInfoAlert.classList.remove('d-none');
        elements.fileInfoAlert.classList.add('fade-in');
    }
        

    // Manejar confirmación de importación
    async function handleImportConfirmation() {
        if (!selectedFile) return;

        abrirImportModal.hide();

        try {
            // Mostrar modal de progreso
            progressModal.show();
            simulateProgress();

            // Crear FormData
            const formData = new FormData();
            formData.append('excelFile', selectedFile);

            // Realizar petición
            const response = await fetch(`${API_BASE_URL}/import`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // Ocultar modal de progreso
            progressModal.hide();

            if (result.success) {
                showResultsModal(result);
            } else {
                showErrorModal(result.message || 'Error al importar el archivo');
            }

        } catch (error) {
            console.error('Error durante importación:', error);
            progressModal.hide();
            showErrorModal('Error de conexión. Por favor intenta nuevamente.');
        } finally {
            resetForm();
        }
    }

    // Simular progreso
    function simulateProgress() {
        let progress = 0;
        const steps = [
            { progress: 25, text: 'Validando archivo...' },
            { progress: 50, text: 'Leyendo datos...' },
            { progress: 75, text: 'Procesando transacciones...' },
            { progress: 90, text: 'Guardando en base de datos...' },
            { progress: 100, text: 'Completado' }
        ];

        function updateProgress() {
            if (progress < steps.length) {
                const step = steps[progress];
                elements.progressBar.style.width = `${step.progress}%`;
                elements.progressText.textContent = step.text;
                progress++;
                setTimeout(updateProgress, 600);
            }
        }

        updateProgress();
    }

    // Mostrar modal de resultados
    function showResultsModal(result) {
        const data = result.data || {};

        // Actualizar estadísticas
        document.getElementById('totalRows').textContent = data.totalRows || 0;
        document.getElementById('processedRows').textContent = data.processedRows || 0;
        document.getElementById('errorRows').textContent = data.errorRows || 0;

        const successRate = data.totalRows > 0 ?
            Math.round((data.processedRows / data.totalRows) * 100) : 0;
        document.getElementById('successRate').textContent = `${successRate}%`;

        // Mensaje de resultado
        document.getElementById('resultMessage').textContent = result.message;

        // Mostrar errores si existen
        if (data.errors && data.errors.length > 0) {
            const errorSection = document.getElementById('errorSection');
            const errorList = document.getElementById('errorList');

            errorList.innerHTML = data.errors.map((error, index) =>
                `<div class="mb-2">
                    <span class="badge bg-danger me-2">${index + 1}</span>${error}
                </div>`
            ).join('');

            errorSection.classList.remove('d-none');
        }

        resultsModal.show();
    }

    // Mostrar modal de error
    function showErrorModal(message) {
        document.getElementById('errorMessage').textContent = message;
        errorModal.show();
    }

    // Resetear formulario
    function resetForm() {
        selectedFile = null;
        elements.fileInput.value = '';
        elements.fileInfoAlert.classList.add('d-none');
        elements.uploadZone.classList.remove('dragover');
    }

    // Formatear tamaño de archivo
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
