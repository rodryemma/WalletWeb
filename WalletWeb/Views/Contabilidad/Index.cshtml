@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Transacciones</h2>

<p>Total en USD: <span id="totalMonto">0.00</span></p>

<div>
    <label for="tipoMovimientoSelect" class="form-label me-2">Filtrar por movimiento:</label>
    <select id="tipoMovimientoSelect" class="form-select w-auto d-inline-block ms-2">
        <option value="total">Total</option>
        <option value="gastos">Gastos</option>
        <option value="ingresos">Ingresos</option>
    </select>
</div>

<div>
    <label>Fecha desde:</label>
    <input type="date" id="fechaDesde">
    <label>Fecha hasta:</label>
    <input type="date" id="fechaHasta">
</div>


<div>
    <table id="tablaTransacciones" class="display">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Categoría</th>
                <th>Cuenta</th>
                <th>Monto Usd</th>
                <th>Comentario</th>
                <th>Tipo Movimiento</th>
                <th>Acción</th>
            </tr>
        </thead>
    </table>
</div>


<!-- Modal de confirmación -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="tituloModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="tituloModal">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que querés eliminar este registro?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de modificación -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="tituloEditar" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloEditar">Editar transacción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formEditar">
                    <input type="hidden" id="editarId" />

                    <div class="mb-2">
                        <label for="editarFecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="editarFecha" required />
                    </div>

                    <div class="mb-2">
                        <label for="editarCategoria" class="form-label">Categoría</label>
                        <input type="text" class="form-control" id="editarCategoria" required />
                    </div>

                    <div class="mb-2">
                        <label for="editarCuenta" class="form-label">Cuenta</label>
                        <input type="text" class="form-control" id="editarCuenta" required />
                    </div>

                    <div class="mb-2">
                        <label for="editarMontoUsd" class="form-label">Monto USD</label>
                        <input type="number" class="form-control" id="editarMontoUsd" required />
                    </div>

                    <div class="mb-2">
                        <label for="editarComentario" class="form-label">Comentario</label>
                        <input type="text" class="form-control" id="editarComentario" />
                    </div>

                    <div class="mb-2">
                        <label for="editarTipoMovimiento" class="form-label">Tipo Movimiento</label>
                        <select class="form-control" id="editarTipoMovimiento">
                            <option value="ingresos">Ingresos</option>
                            <option value="gastos">Gastos</option>
                        </select>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnGuardarCambios">Guardar</button>
            </div>
        </div>
    </div>
</div>


@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css">
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.min.js"></script>

    <script>
        $(document).ready(function () {
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            let fechaDesde = $('#fechaDesde').val();
            let fechaHasta = $('#fechaHasta').val();
            let fechaColumna = data[0]; 

            if (!fechaColumna) return false;

            // Convertir a formato compatible (si es necesario)
            let fecha = new Date(fechaColumna.split('/').reverse().join('-'));
            let desde = fechaDesde ? new Date(fechaDesde) : null;
            let hasta = fechaHasta ? new Date(fechaHasta) : null;

            return (!desde || fecha >= desde) && (!hasta || fecha <= hasta);
            });

            $('#fechaDesde, #fechaHasta').on('change', function () {
                $('#tablaTransacciones').DataTable().draw();
            });

            var tabla = $('#tablaTransacciones').DataTable({
                responsive: true,
                paging: true,
                destroy: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                ajax: {
                    url: '/transacciones/json',
                    data: function (d) {
                         d.tipoMovimiento = $('#tipoMovimientoSelect').val();
                    }
                },
                order: [[0, 'desc']],//Fecha de forma descendente
                columns: [
                    {
                        data: 'fecha',
                        title: 'Fecha',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                const date = new Date(data);
                                return date.toLocaleDateString();
                            }
                            return data;
                        }
                    },
                    { data: 'categoria' },
                    { data: 'cuenta' },
                    { 
                        data: 'montoUsd' ,
                        render: $.fn.dataTable.render.number(',', '.', 2, '$')
                    },
                    { data: 'comentario' },
                    { data: 'tipoMovimiento' },
                    {
                      data: null,
                      orderable: false,
                      searchable: false,
                      render: function (data, type, row) {
                          return `
                              <button class="btn-editar btn btn-sm btn-primary" data-id="${row.id}">Editar</button>
                              <button class="btn-eliminar btn btn-sm btn-danger" data-id="${row.id}">
                                      Eliminar 
                                      <i class="bi bi-trash-fill"></i>
                              </button>
                          `;
                      }
                    }
                    ],
                    footerCallback: function (row, data, start, end, display) {
                        var api = this.api();
                        var total = api
                            .column(3, { filter: 'applied' })//Hacemos que se aplique el filtro en la celda 3 montoUsd
                            .data()
                            .reduce(function (a, b) {
                                var x = typeof a === 'string' ? parseFloat(a.replace(/[\$,]/g, '')) : a;
                                var y = typeof b === 'string' ? parseFloat(b.replace(/[\$,]/g, '')) : b;
                                return (x || 0) + (y || 0);
                            }, 0);

                     // Mostrar el total
                     $('#totalMonto').text(total.toFixed(2));
                    }
            });

            $('#tipoMovimientoSelect').change(function () {
            tabla.ajax.reload();
            });
        });

        
        let idAEliminar = null;

        $('#tablaTransacciones').on('click', '.btn-eliminar', function () {
            // var id = $(this).data('id');
            idAEliminar = $(this).data('id');
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
            modal.show();
        });
          

        $('#btnConfirmarEliminar').on('click', function () {
            // TODO deshabilitar el boton o buscar la manera de no enviar varias peticiones
            if (idAEliminar !== null) {
                //console.log('Eliminar ID:', idAEliminar);
                const data = { id : idAEliminar };
                $.ajax({
                    url: `/transacciones/eliminar`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function () {
                        $('#tablaTransacciones').DataTable().ajax.reload();
                        idAEliminar = null;
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarEliminar'));
                        modal.hide();
                        // TODO Opcional: mostrar un toast o mensaje de éxito
                    },
                    error: function () {
                        alert("Error al eliminar el registro.");
                    }
                });
            }
        });

        $('#tablaTransacciones').on('click', '.btn-editar', function () {
            const id = $(this).data('id');
            
            const row = $('#tablaTransacciones').DataTable().row($(this).parents('tr')).data();
                          
            const fechaFormateada = row.fecha.toString().split('T')[0];
            console.log("Valor crudo de Fecha:", row.id);
            // Llenamos los campos del modal con los datos
            $('#editarId').val(row.id);
            $('#editarFecha').val(fechaFormateada);
            $('#editarCategoria').val(row.categoria);
            $('#editarCuenta').val(row.cuenta);
            $('#editarMontoUsd').val(row.montoUsd);
            $('#editarComentario').val(row.comentario);
            $('#editarTipoMovimiento').val(row.tipoMovimiento);

            const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
            modal.show();
        });

        $('#btnGuardarCambios').on('click', function () {
            // TODO deshabilitar el boton o buscar la manera de no enviar varias peticiones
            const data = {
                Id: $('#editarId').val(),
                Fecha: $('#editarFecha').val(),
                Categoria: $('#editarCategoria').val(),
                Cuenta: $('#editarCuenta').val(),
                MontoUsd: parseFloat($('#editarMontoUsd').val()),
                Comentario: $('#editarComentario').val(),
                TipoMovimiento: $('#editarTipoMovimiento').val()
            };
            
            $.ajax({
                url: '/transacciones/editar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function () {
                    $('#tablaTransacciones').DataTable().ajax.reload();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditar'));
                    modal.hide();
                },
                error: function () {
                    alert('Error al guardar los cambios.');
                }
            });
        });


    </script>
}
